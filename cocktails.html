<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cocktail Recipe Finder</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            .ingredient-tag {
                display: inline-block;
                background-color: #e9ecef;
                padding: 0.4rem 0.8rem;
                margin: 0.2rem;
                border-radius: 2rem;
                font-size: 0.9rem;
            }
            .missing-ingredient {
                background-color: #f8d7da;
            }
            .available-ingredient {
                background-color: #d1e7dd;
            }
            .garnish-ingredient {
                background-color: #fff3cd;
                border: 1px dashed #ffc107;
            }
            .search-container {
                margin-bottom: 2rem;
            }
            .card {
                margin-bottom: 1.5rem;
                height: 100%;
            }
            .cocktail-img {
                height: 200px;
                object-fit: cover;
            }
            #ingredientInput {
                margin-bottom: 1rem;
            }
            #selectedIngredients {
                margin-bottom: 1rem;
            }
            .mode-toggle {
                margin-bottom: 1.5rem;
            }
            .badge {
                margin-right: 0.5rem;
            }
            .card-subtitle {
                margin-bottom: 0.75rem;
                color: #6c757d;
            }
        </style>
    </head>
    <body>
        <div class="container py-4">
            <h1 class="mb-4 text-center">Cocktail Recipe Finder</h1>

            <!-- Search Mode Toggle -->
            <div class="mode-toggle text-center">
                <div class="btn-group" role="group">
                    <input
                        type="radio"
                        class="btn-check"
                        name="searchMode"
                        id="modeOne"
                        value="missing"
                        checked
                    />
                    <label class="btn btn-outline-primary" for="modeOne"
                        >Find recipes using ALL ingredients & show
                        missing</label
                    >

                    <input
                        type="radio"
                        class="btn-check"
                        name="searchMode"
                        id="modeTwo"
                        value="complete"
                    />
                    <label class="btn btn-outline-primary" for="modeTwo"
                        >Find recipes I can make now (ignoring garnishes)</label
                    >
                </div>
            </div>

            <!-- Ingredient Search -->
            <div class="search-container">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input
                                type="text"
                                id="ingredientInput"
                                class="form-control"
                                placeholder="Enter an ingredient..."
                            />
                            <button class="btn btn-primary" id="addIngredient">
                                Add
                            </button>
                        </div>
                        <div id="selectedIngredients" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div class="row" id="results"></div>
        </div>

        <script>
            // Main application code
            document.addEventListener("DOMContentLoaded", () => {
                let cocktailData = []; // Will store our loaded JSON data
                let selectedIngredients = new Set(); // Stores user-selected ingredients
                let garnishData = { garnishes: {} }; // Initialize garnishData with a default structure

                // Common garnish ingredients and terms
                const garnishItems = [
                    "lemon peel",
                    "lemon twist",
                    "lemon zest",
                    "lemon slice",
                    "lemon wedge",
                    "lime peel",
                    "lime twist",
                    "lime zest",
                    "lime slice",
                    "lime wedge",
                    "orange peel",
                    "orange twist",
                    "orange zest",
                    "orange slice",
                    "orange wedge",
                    "grapefruit peel",
                    "grapefruit twist",
                    "grapefruit zest",
                    "mint leaves",
                    "mint sprig",
                    "mint leaf",
                    "cherry",
                    "maraschino cherry",
                    "cocktail cherry",
                    "olive",
                    "cocktail olive",
                    "olives",
                    "salt rim",
                    "salt",
                    "coarse salt",
                    "salt for rimming",
                    "sugar rim",
                    "sugar",
                    "sugar for rimming",
                    "cinnamon stick",
                    "star anise",
                    "nutmeg",
                    "whipped cream",
                    "ice cream",
                    "whip cream",
                    "ice",
                    "cubed ice",
                    "crushed ice",
                    "ice cubes",
                    "umbrella",
                    "cocktail umbrella",
                    "cocktail stick",
                    "stir stick",
                    "rosemary sprig",
                    "thyme sprig",
                    "basil leaf",
                    "pepper",
                    "ground pepper",
                    "ground cinnamon",
                ];

                // DOM elements
                const ingredientInput =
                    document.getElementById("ingredientInput");
                const addIngredientBtn =
                    document.getElementById("addIngredient");
                const selectedIngredientsDiv = document.getElementById(
                    "selectedIngredients",
                );
                const resultsDiv = document.getElementById("results");
                const modeRadios = document.querySelectorAll(
                    'input[name="searchMode"]',
                );

                // Load the garnish data first
                fetch("garnish.json")
                    .then((response) => response.json())
                    .then((data) => {
                        garnishData = data;
                        console.log("Loaded garnish data successfully");
                        // After garnish data is loaded, load the cocktail data
                        return fetch("cocktails.json");
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        // Extract the cocktails array from the JSON
                        cocktailData = data.cocktails;
                        console.log(
                            "Loaded cocktail data:",
                            cocktailData.length,
                            "recipes",
                        );

                        // Create a list of all available ingredients for autocomplete
                        createIngredientsList();
                    })
                    .catch((error) => {
                        console.error("Error loading data:", error);
                        resultsDiv.innerHTML =
                            '<div class="col-12 text-center text-danger">Error loading data. Please check console for details.</div>';
                    });

                // Add ingredient to selected list
                addIngredientBtn.addEventListener("click", () => {
                    addIngredient();
                });

                // Allow pressing Enter to add ingredient
                ingredientInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        addIngredient();
                    }
                });

                // Handle mode change (search type)
                modeRadios.forEach((radio) => {
                    radio.addEventListener("change", () => {
                        searchCocktails();
                    });
                });

                // Function to check if an ingredient is likely a garnish
                function isGarnish(ingredient) {
                    const product = ingredient.product.toLowerCase();

                    // If garnishData hasn't loaded yet or is incomplete, use the garnishItems array
                    if (!garnishData || !garnishData.garnishes) {
                        return garnishItems.includes(product);
                    }

                    // List of common juices and liquids that should NOT be considered garnishes
                    const notGarnishes = [
                        "juice",
                        "syrup",
                        "liqueur",
                        "liquor",
                        "vodka",
                        "gin",
                        "rum",
                        "tequila",
                        "whiskey",
                        "whisky",
                        "bourbon",
                        "brandy",
                        "cognac",
                        "schnapps",
                        "wine",
                        "vermouth",
                        "bitters",
                        "water",
                        "milk",
                        "cream",
                        "soda",
                        "cordial",
                    ];

                    // If the product contains words indicating it's not a garnish, return false
                    if (notGarnishes.some((term) => product.includes(term))) {
                        return false;
                    }

                    // Check if product exactly matches any garnish in any category
                    for (const category in garnishData.garnishes) {
                        if (
                            category !== "specialUnits" &&
                            category !== "smallMeasurementUnits"
                        ) {
                            // First check for exact matches
                            if (
                                garnishData.garnishes[category].includes(
                                    product,
                                )
                            ) {
                                return true;
                            }

                            // Then check for partial matches, but be more careful
                            if (
                                garnishData.garnishes[category].some(
                                    (garnish) => {
                                        // Check if garnish is a substring of product, but only if:
                                        // 1. It's at the beginning of the product name, or
                                        // 2. It follows a space (is a complete word)
                                        // This prevents "grapefruit" from matching "grapefruit juice"
                                        return (
                                            product === garnish ||
                                            product.startsWith(garnish + " ") ||
                                            product.includes(" " + garnish)
                                        );
                                    },
                                )
                            ) {
                                return true;
                            }
                        }
                    }

                    // Check for special units like "twist of"
                    if (
                        garnishData.garnishes.specialUnits &&
                        garnishData.garnishes.specialUnits.includes(
                            ingredient.unit,
                        )
                    ) {
                        return true;
                    }

                    // Check for very small amounts that might indicate a garnish
                    if (
                        garnishData.garnishes.smallMeasurementUnits &&
                        ingredient.amount <= 1 &&
                        garnishData.garnishes.smallMeasurementUnits.includes(
                            ingredient.unit,
                        )
                    ) {
                        return true;
                    }

                    return false;
                }

                // Create a list of all ingredients from the cocktail data
                function createIngredientsList() {
                    // This could be used for autocomplete functionality in a future enhancement
                    const allIngredients = new Set();

                    cocktailData.forEach((cocktail) => {
                        cocktail.ingredients.forEach((ingredient) => {
                            allIngredients.add(
                                ingredient.product.toLowerCase(),
                            );
                        });
                    });

                    console.log(
                        "Found",
                        allIngredients.size,
                        "unique ingredients",
                    );
                }

                // Function to add an ingredient to the selected list
                function addIngredient() {
                    const ingredient = ingredientInput.value
                        .trim()
                        .toLowerCase();
                    if (ingredient && !selectedIngredients.has(ingredient)) {
                        selectedIngredients.add(ingredient);
                        updateSelectedIngredientsUI();
                        searchCocktails();
                        ingredientInput.value = "";
                    }
                    ingredientInput.focus();
                }

                // Update the UI showing selected ingredients
                function updateSelectedIngredientsUI() {
                    selectedIngredientsDiv.innerHTML = "";

                    selectedIngredients.forEach((ingredient) => {
                        const tag = document.createElement("span");
                        tag.className = "ingredient-tag me-2";
                        tag.innerHTML = `${ingredient} <button class="btn-close btn-close-sm ms-1" data-ingredient="${ingredient}"></button>`;
                        selectedIngredientsDiv.appendChild(tag);
                    });

                    // Add event listeners to remove buttons
                    document.querySelectorAll(".btn-close").forEach((btn) => {
                        btn.addEventListener("click", (e) => {
                            const ingredientToRemove =
                                e.currentTarget.getAttribute("data-ingredient");
                            selectedIngredients.delete(ingredientToRemove);
                            updateSelectedIngredientsUI();
                            searchCocktails();
                        });
                    });
                }

                // Main search function
                function searchCocktails() {
                    if (selectedIngredients.size === 0) {
                        resultsDiv.innerHTML =
                            '<div class="col-12 text-center">Add ingredients to find cocktails</div>';
                        return;
                    }

                    const searchMode = document.querySelector(
                        'input[name="searchMode"]:checked',
                    ).value;
                    let matchingCocktails = [];

                    if (searchMode === "missing") {
                        // Mode 1: Find cocktails that use ALL the selected ingredients (and may need more)
                        matchingCocktails = cocktailData.filter((cocktail) => {
                            // Get all ingredient products for this cocktail
                            const cocktailIngredients =
                                cocktail.ingredients.map((ing) =>
                                    ing.product.toLowerCase(),
                                );

                            // Check if ALL selected ingredients are used in this cocktail
                            return Array.from(selectedIngredients).every(
                                (selected) =>
                                    cocktailIngredients.includes(selected),
                            );
                        });
                    } else {
                        // Mode 2: Find cocktails where all required ingredients (except garnishes) are available
                        matchingCocktails = cocktailData.filter((cocktail) => {
                            // Check if all essential (non-garnish) ingredients are in the selected ingredients
                            return cocktail.ingredients.every((ingredient) => {
                                // If it's a garnish, don't consider it required
                                if (isGarnish(ingredient)) {
                                    return true; // Always pass garnishes
                                }
                                // For non-garnishes, check if we have them
                                return selectedIngredients.has(
                                    ingredient.product.toLowerCase(),
                                );
                            });
                        });
                    }

                    displayResults(matchingCocktails, searchMode);
                }

                // Format the amount and unit for display
                function formatAmount(ingredient) {
                    let amount = ingredient.amount;
                    let unit = ingredient.unit;

                    // Handle special case for "twist of" unit
                    if (unit === "twist of") {
                        return `${amount} ${unit}`;
                    }

                    // Normal case with units like cl, oz, etc.
                    return `${amount} ${unit}`;
                }

                // Display search results
                function displayResults(cocktails, mode) {
                    if (cocktails.length === 0) {
                        resultsDiv.innerHTML =
                            '<div class="col-12 text-center">No matching cocktails found</div>';
                        return;
                    }

                    resultsDiv.innerHTML = "";

                    // Sort cocktails by number of missing ingredients (for mode 1)
                    if (mode === "missing") {
                        cocktails.sort((a, b) => {
                            const aMissing = a.ingredients.filter(
                                (ingredient) =>
                                    !selectedIngredients.has(
                                        ingredient.product.toLowerCase(),
                                    ),
                            ).length;
                            const bMissing = b.ingredients.filter(
                                (ingredient) =>
                                    !selectedIngredients.has(
                                        ingredient.product.toLowerCase(),
                                    ),
                            ).length;
                            return aMissing - bMissing;
                        });
                    }

                    cocktails.forEach((cocktail) => {
                        const essentialMissingIngredients =
                            cocktail.ingredients.filter(
                                (ingredient) =>
                                    !isGarnish(ingredient) &&
                                    !selectedIngredients.has(
                                        ingredient.product.toLowerCase(),
                                    ),
                            );

                        const garnishMissingIngredients =
                            cocktail.ingredients.filter(
                                (ingredient) =>
                                    isGarnish(ingredient) &&
                                    !selectedIngredients.has(
                                        ingredient.product.toLowerCase(),
                                    ),
                            );

                        const cocktailCard = document.createElement("div");
                        cocktailCard.className = "col-md-4 mb-4";

                        let ingredientsHTML = "";
                        let statusBadgeHTML = "";

                        // Prepare the badge for missing ingredients
                        if (mode === "missing") {
                            if (essentialMissingIngredients.length > 0) {
                                statusBadgeHTML = `<span class="badge bg-warning">${essentialMissingIngredients.length} missing essential ingredient${essentialMissingIngredients.length > 1 ? "s" : ""}</span>`;
                            } else if (garnishMissingIngredients.length > 0) {
                                statusBadgeHTML = `<span class="badge bg-success">All essential ingredients available!</span> <span class="badge bg-warning text-dark">${garnishMissingIngredients.length} missing garnish${garnishMissingIngredients.length > 1 ? "es" : ""}</span>`;
                            } else {
                                statusBadgeHTML = `<span class="badge bg-success">All ingredients available!</span>`;
                            }
                        } else {
                            // For mode 2, all essential ingredients are available by definition
                            if (garnishMissingIngredients.length > 0) {
                                statusBadgeHTML = `<span class="badge bg-success">All essential ingredients available!</span> <span class="badge bg-warning text-dark">${garnishMissingIngredients.length} optional garnish${garnishMissingIngredients.length > 1 ? "es" : ""} missing</span>`;
                            } else {
                                statusBadgeHTML = `<span class="badge bg-success">All ingredients available!</span>`;
                            }
                        }

                        // Prepare the ingredients list
                        cocktail.ingredients.forEach((ingredient) => {
                            const isAvailable = selectedIngredients.has(
                                ingredient.product.toLowerCase(),
                            );
                            const isGarnishItem = isGarnish(ingredient);

                            let tagClass = "ingredient-tag ";
                            if (isGarnishItem) {
                                tagClass += isAvailable
                                    ? "available-ingredient garnish-ingredient"
                                    : "missing-ingredient garnish-ingredient";
                            } else {
                                tagClass += isAvailable
                                    ? "available-ingredient"
                                    : "missing-ingredient";
                            }

                            ingredientsHTML += `<span class="${tagClass}" title="${isGarnishItem ? "Garnish" : "Essential ingredient"}">${ingredient.product}: ${formatAmount(ingredient)}</span> `;
                        });

                        // Use placeholder image if imageURL is empty
                        const imageUrl =
                            cocktail.imageURL ||
                            "https://placehold.co/400x300?text=No+Image";

                        cocktailCard.innerHTML = `
                        <div class="card">
                            <img src="${imageUrl}" class="card-img-top cocktail-img" alt="${cocktail.name}">
                            <div class="card-body">
                                <h5 class="card-title">${cocktail.name}</h5>
                                <h6 class="card-subtitle mb-2">
                                    ${cocktail.category}
                                    <span class="badge ${cocktail.alcoholic ? "bg-danger" : "bg-success"}">${cocktail.alcoholic ? "Alcoholic" : "Non-alcoholic"}</span>
                                </h6>
                                <div class="mb-2">
                                    ${statusBadgeHTML}
                                </div>
                                <div class="ingredients mb-3">
                                    ${ingredientsHTML}
                                </div>
                                <p class="card-text">${cocktail.instructions}</p>
                                <p class="text-muted small">Serve in: ${cocktail.glass}</p>
                            </div>
                        </div>
                    `;

                        resultsDiv.appendChild(cocktailCard);
                    });
                }
            });
        </script>
    </body>
</html>